<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Printer</title>
    <script src="node_modules\@point-of-sale\webbluetooth-receipt-printer\dist\webbluetooth-receipt-printer.umd.js"></script>
    <script src='node_modules\@point-of-sale\receipt-printer-status\dist\receipt-printer-status.umd.js'></script>
</head>

<body>

    <button onclick="handleConnectButtonClick()">Connect to Printer</button>
    <p id="status"></p>

    <script>
        const receiptPrinter = new WebBluetoothReceiptPrinter();
        let lastUsedDevice = null;
    
        async function handleConnectButtonClick() {
            console.log("Attempting to connect to RPP02N...");
            document.getElementById("status").textContent = "Searching for printer...";
    
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'RPP02N' }]
                });
    
                console.log(`Found device: ${device.name}`);
                lastUsedDevice = device;
    
                const server = await device.gatt.connect();
                console.log("Connected to the Bluetooth device");
                console.log("Attempting to connect to receipt printer...");
                await receiptPrinter.connect();
                console.log("Receipt printer connected successfully");
    
                handlePrinterConnection(device); 
    
            } catch (error) {
                console.error("Failed to connect to Bluetooth device:", error);
                document.getElementById("status").textContent = "Failed to connect. Please try again.";
    
                if (error.name === "NotFoundError") {
                    console.log("User canceled the device selection.");
                    document.getElementById("status").textContent = "You canceled the device selection. Please try again.";
                } else {
                    console.log("Unexpected error:", error);
                }
            }
        }
    
        function handlePrinterConnection(device) {
            try {
                console.log("Handling printer connection...");
                receiptPrinter.addEventListener('connected', (device) => {
                    console.log(`Connected to device: ${device.name} (#${device.id})`);
    
                    const printerLanguage = device.language;
                    const printerCodepageMapping = device.codepageMapping;
                    console.log(`Printer Language: ${printerLanguage}`);
                    console.log(`Printer Codepage Mapping: ${printerCodepageMapping}`);
    
                    let encoder = new ReceiptPrinterEncoder({
                        language: printerLanguage,
                        codepageMapping: printerCodepageMapping
                    });
    
                    console.log("Encoding data for printing...");
                    let data = encoder
                        .initialize()
                        .text('The quick brown fox jumps over the lazy dog')
                        .newline()
                        .qrcode('https://sneevilz.my.id')
                        .encode();
    
                    console.log("Sending data to printer...");
                    receiptPrinter.print(data).then(() => {
                        console.log("Printing data...");
                        document.getElementById("status").textContent = "Printing...";
                    }).catch((error) => {
                        console.error("Error printing:", error);
                        document.getElementById("status").textContent = "Error while printing. Check the printer.";
                    });
                });
            } catch (printerError) {
                console.error("Error during printer connection or printing:", printerError);
                document.getElementById("status").textContent = "Error connecting to printer.";
            }
        }
    </script>
    
    
</body>

</html>
